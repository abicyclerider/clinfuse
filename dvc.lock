schema: '2.0'
stages:
  generate:
    cmd: rm -rf synthea-runner/output/synthea_raw && docker build -t synthea 
      synthea-runner/synthea-docker/ && docker run --rm -e JAVA_OPTS=-Xmx8g -v 
      $(pwd)/synthea-runner/output/synthea_raw:/synthea/synthea/output synthea 
      /bin/sh -c "./run_synthea -p 500 -s 67890 
      --exporter.baseDirectory=./output --exporter.csv.export=true 
      --exporter.fhir.export=false Massachusetts"
    deps:
    - path: synthea-runner/synthea-docker/Dockerfile
      hash: md5
      md5: 1369d1d9cd02662b7bf3fe723a265ca1
      size: 1433
    params:
      params.yaml:
        generate.population: 500
        generate.seed: 67890
    outs:
    - path: synthea-runner/output/synthea_raw/csv
      hash: md5
      md5: 062b740a84dab00c72bbd571505a15e5.dir
      size: 533089104
      nfiles: 18
  augment:
    cmd: rm -rf output/augmented && docker build -t augmentation augmentation/ 
      && docker run --rm -v 
      $(pwd)/synthea-runner/output/synthea_raw/csv:/data/input:ro -v 
      $(pwd)/output/augmented:/data/output augmentation --input /data/input 
      --output /data/output --random-seed 99
    deps:
    - path: augmentation/Dockerfile
      hash: md5
      md5: 15dd455982ee6b64f848ddb66fb2cee2
      size: 256
    - path: augmentation/cli/augment.py
      hash: md5
      md5: 8cd43472f858ada64824d3f6a4636ef4
      size: 14071
    - path: augmentation/config/default_config.yaml
      hash: md5
      md5: 6bc905898e0280c554b96ec931cc6c96
      size: 1447
    - path: augmentation/requirements-runtime.txt
      hash: md5
      md5: a84415c3be592d7ac92177a1b5e62dea
      size: 207
    - path: synthea-runner/output/synthea_raw/csv
      hash: md5
      md5: 062b740a84dab00c72bbd571505a15e5.dir
      size: 533089104
      nfiles: 18
    params:
      params.yaml:
        augment.random_seed: 99
    outs:
    - path: output/augmented
      hash: md5
      md5: 20f2c068621a8002aec4305f0f7c6ae5.dir
      size: 606842373
      nfiles: 185
  resolve:
    cmd: rm -rf output/resolved && docker build -f entity-resolution/Dockerfile 
      -t entity-resolution . && docker run --rm -v 
      $(pwd)/output/augmented:/data/augmented:ro -v 
      $(pwd)/output/resolved:/data/resolved entity-resolution python 
      entity-resolution/resolve.py --augmented-dir /data/augmented --output-dir 
      /data/resolved --config entity-resolution/config/matching_config.yaml
    deps:
    - path: entity-resolution/Dockerfile
      hash: md5
      md5: aa2df09e7babc2dd685536ad3ac410c4
      size: 270
    - path: entity-resolution/config/matching_config.yaml
      hash: md5
      md5: e5bb76c29675db209dfd29c605ecbdff
      size: 967
    - path: entity-resolution/requirements-runtime.txt
      hash: md5
      md5: d13f3c7c6ca570bf53088237cee608c6
      size: 180
    - path: entity-resolution/resolve.py
      hash: md5
      md5: 5feaab26cf4144d017783903f510b542
      size: 10322
    - path: entity-resolution/src/
      hash: md5
      md5: 348c5c41c66756d48795c775a0398e74.dir
      size: 133533
      nfiles: 17
    - path: output/augmented
      hash: md5
      md5: 20f2c068621a8002aec4305f0f7c6ae5.dir
      size: 606842373
      nfiles: 185
    - path: shared/
      hash: md5
      md5: 263e4b1c54456b060fe5f89858914a1e.dir
      size: 42588
      nfiles: 12
    params:
      params.yaml:
        resolve.auto_match_probability: 0.95
        resolve.auto_reject_probability: 0.05
    outs:
    - path: output/resolved
      hash: md5
      md5: 7d7c749cdaa7a83692dac3da42b909f3.dir
      size: 4123585
      nfiles: 4
  golden_records:
    cmd: rm -rf output/golden_records && docker run --rm -v 
      $(pwd)/output/augmented:/data/augmented:ro -v 
      $(pwd)/output/resolved:/data/resolved:ro -v 
      $(pwd)/output/inferred:/data/inferred:ro -v 
      $(pwd)/output/golden_records:/data/golden_records entity-resolution python
      entity-resolution/build_golden_records.py --augmented-dir /data/augmented 
      --auto-matches /data/resolved/auto_matches.csv --predictions 
      /data/inferred/predictions.csv --features /data/resolved/features.csv 
      --output-dir /data/golden_records --config 
      entity-resolution/config/matching_config.yaml
    deps:
    - path: entity-resolution/build_golden_records.py
      hash: md5
      md5: ac644010d026c98b117fa78ff9afa2fe
      size: 10286
    - path: entity-resolution/src/
      hash: md5
      md5: 348c5c41c66756d48795c775a0398e74.dir
      size: 133533
      nfiles: 17
    - path: output/augmented
      hash: md5
      md5: 20f2c068621a8002aec4305f0f7c6ae5.dir
      size: 606842373
      nfiles: 185
    - path: output/inferred/predictions.csv
      hash: md5
      md5: ae8b138473ca3f89a9c290e42fc9b043
      size: 2917686
    - path: output/resolved/auto_matches.csv
      hash: md5
      md5: 3f2d75a2b161955b901ba298a4657592
      size: 141481
    - path: output/resolved/features.csv
      hash: md5
      md5: 93ccffed054e1bf734d62340d94811db
      size: 1067273
    - path: shared/
      hash: md5
      md5: 263e4b1c54456b060fe5f89858914a1e.dir
      size: 42588
      nfiles: 12
    outs:
    - path: output/golden_records
      hash: md5
      md5: ba1e2939e1530caba71197e2a9c6c501.dir
      size: 306913
      nfiles: 3
  infer:
    cmd: rm -rf output/inferred && mkdir -p output/inferred && 
      fine-tuning/infer_remote.sh output/resolved/gray_zone_pairs.csv 
      output/inferred/predictions.csv
    deps:
    - path: fine-tuning/Dockerfile
      hash: md5
      md5: 7118cbc8dc48ea53c508065076d0d425
      size: 1309
    - path: fine-tuning/_remote_helpers.sh
      hash: md5
      md5: 94c2e7d4b9322c238878e87f23d1a01f
      size: 10532
    - path: fine-tuning/infer_remote.sh
      hash: md5
      md5: c1baa3aa072e825180c5d996c9e3406b
      size: 5346
      isexec: true
    - path: fine-tuning/inference_classifier.py
      hash: md5
      md5: 6d6b346ab623706e5c231ecc491bf1c5
      size: 15835
    - path: fine-tuning/requirements.txt
      hash: md5
      md5: c18a171753741de19258bb92ea08add9
      size: 171
    - path: fine-tuning/run_on_runpod.sh
      hash: md5
      md5: c3615aee47203ba0e6bedb4fd09c4169
      size: 4089
      isexec: true
    - path: output/resolved/gray_zone_pairs.csv
      hash: md5
      md5: 1ed81ffc322c5e6846cfb93102492b6d
      size: 2914399
    outs:
    - path: output/inferred/predictions.csv
      hash: md5
      md5: ae8b138473ca3f89a9c290e42fc9b043
      size: 2917686
  train_scorer:
    cmd: rm -rf output/scorer && docker run --rm -v 
      $(pwd)/output/augmented:/data/augmented:ro -v 
      $(pwd)/output/resolved:/data/resolved:ro -v 
      $(pwd)/output/inferred:/data/inferred:ro -v 
      $(pwd)/output/scorer:/data/scorer entity-resolution python 
      entity-resolution/train_scorer.py --augmented-dir /data/augmented 
      --features /data/resolved/features.csv --predictions 
      /data/inferred/predictions.csv --output-dir /data/scorer
    deps:
    - path: entity-resolution/Dockerfile
      hash: md5
      md5: aa2df09e7babc2dd685536ad3ac410c4
      size: 270
    - path: entity-resolution/src/
      hash: md5
      md5: ac01e60838228d102b6b62db67e9be60.dir
      size: 89748
      nfiles: 13
    - path: entity-resolution/train_scorer.py
      hash: md5
      md5: 51b1464ba837f10602576d0167c80370
      size: 8326
    - path: output/augmented
      hash: md5
      md5: 4549fb5837ad07fe383e8bcb4948abd6.dir
      size: 533496994
      nfiles: 95
    - path: output/inferred/predictions.csv
      hash: md5
      md5: e54ab911add8ef1edf55ec7f5cf12402
      size: 6566366
    - path: output/resolved/features.csv
      hash: md5
      md5: f00eb320148f532263fc455c795a8a63
      size: 4802770
    - path: shared/
      hash: md5
      md5: dee2997ebbb4933304e9afa4bf0b7ce7.dir
      size: 30371
      nfiles: 10
    outs:
    - path: output/scorer
      hash: md5
      md5: ca86d9b96ae24ae89cb79ee5de47d04c.dir
      size: 3488
      nfiles: 2
  generate_training:
    cmd: rm -rf output/training/synthea_raw && docker build -t synthea 
      synthea-runner/synthea-docker/ && docker run --rm -e JAVA_OPTS=-Xmx8g -v 
      $(pwd)/output/training/synthea_raw:/synthea/synthea/output synthea /bin/sh
      -c "./run_synthea -p 500 -s 12345 --exporter.baseDirectory=./output 
      --exporter.csv.export=true --exporter.fhir.export=false Massachusetts"
    deps:
    - path: synthea-runner/synthea-docker/Dockerfile
      hash: md5
      md5: 1369d1d9cd02662b7bf3fe723a265ca1
      size: 1433
    params:
      params.yaml:
        generate_training.population: 500
        generate_training.seed: 12345
    outs:
    - path: output/training/synthea_raw/csv
      hash: md5
      md5: 9509cd74c947cbfef31a20f406accf6d.dir
      size: 531322985
      nfiles: 18
  augment_training:
    cmd: rm -rf output/training/augmented && docker build -t augmentation 
      augmentation/ && docker run --rm -v 
      $(pwd)/output/training/synthea_raw/csv:/data/input:ro -v 
      $(pwd)/output/training/augmented:/data/output augmentation --input 
      /data/input --output /data/output --random-seed 42
    deps:
    - path: augmentation/Dockerfile
      hash: md5
      md5: 15dd455982ee6b64f848ddb66fb2cee2
      size: 256
    - path: augmentation/cli/augment.py
      hash: md5
      md5: 8cd43472f858ada64824d3f6a4636ef4
      size: 14071
    - path: augmentation/config/default_config.yaml
      hash: md5
      md5: 6bc905898e0280c554b96ec931cc6c96
      size: 1447
    - path: augmentation/requirements-runtime.txt
      hash: md5
      md5: a84415c3be592d7ac92177a1b5e62dea
      size: 207
    - path: output/training/synthea_raw/csv
      hash: md5
      md5: 9509cd74c947cbfef31a20f406accf6d.dir
      size: 531322985
      nfiles: 18
    params:
      params.yaml:
        augment_training.random_seed: 42
    outs:
    - path: output/training/augmented
      hash: md5
      md5: 05b85fdb393a2ead9e59234fa2950cc4.dir
      size: 607301777
      nfiles: 185
  prepare_dataset:
    cmd: rm -rf output/training/dataset && mkdir -p output/training/dataset && 
      python fine-tuning/prepare_dataset.py --augmented-dir 
      output/training/augmented --output-dir output/training/dataset --seed 42
    deps:
    - path: fine-tuning/prepare_dataset.py
      hash: md5
      md5: c699ef209ab3713ec41b3e00e808e92d
      size: 11644
    - path: output/training/augmented
      hash: md5
      md5: 05b85fdb393a2ead9e59234fa2950cc4.dir
      size: 607301777
      nfiles: 185
    - path: shared/data_loader.py
      hash: md5
      md5: 22e286cab87a8b9357e5458143a2e169
      size: 4245
    - path: shared/ground_truth.py
      hash: md5
      md5: c603c1f4f0d5d0ffac4ee994c71460f0
      size: 2838
    - path: shared/medical_records.py
      hash: md5
      md5: d8082f66cb290f836abf57a9180e3a16
      size: 3508
    - path: shared/summarize.py
      hash: md5
      md5: 8caae3e1a6f5ec4375327c7bd70f26b9
      size: 5040
    params:
      params.yaml:
        prepare_dataset.seed: 42
    outs:
    - path: output/training/dataset/dataset_info.json
      hash: md5
      md5: 13b4fb84cd30e8fe0a57470e45d0dfa6
      size: 228
  train:
    cmd: rm -rf output/training/train && mkdir -p output/training/train && 
      fine-tuning/train_remote.sh --gpu-type "NVIDIA H100 80GB HBM3" 
      output/training/train -- --epochs 3 --batch-size 4 --lr 0.0001 
      --max-length 2048 --lora-r 16
    deps:
    - path: fine-tuning/Dockerfile
      hash: md5
      md5: 7118cbc8dc48ea53c508065076d0d425
      size: 1309
    - path: fine-tuning/_remote_helpers.sh
      hash: md5
      md5: 94c2e7d4b9322c238878e87f23d1a01f
      size: 10532
    - path: fine-tuning/requirements.txt
      hash: md5
      md5: c18a171753741de19258bb92ea08add9
      size: 171
    - path: fine-tuning/run_on_runpod.sh
      hash: md5
      md5: c3615aee47203ba0e6bedb4fd09c4169
      size: 4089
      isexec: true
    - path: fine-tuning/train_classifier_on_gpu.py
      hash: md5
      md5: 240ed338aba9b41dc5aeaa2cbddb6dc8
      size: 10012
    - path: fine-tuning/train_remote.sh
      hash: md5
      md5: 1b4370d46be93212ca06551948fa603b
      size: 3290
      isexec: true
    - path: output/training/dataset/dataset_info.json
      hash: md5
      md5: 13b4fb84cd30e8fe0a57470e45d0dfa6
      size: 228
    params:
      params.yaml:
        train.batch_size: 4
        train.epochs: 3
        train.lora_r: 16
        train.lr: 0.0001
        train.max_length: 2048
    outs:
    - path: output/training/train/train_metrics.json
      hash: md5
      md5: fe246361d01d066035b47534e93cad94
      size: 332
